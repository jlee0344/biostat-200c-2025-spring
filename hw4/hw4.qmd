---
title: "Biostat 200C Homework 4"
subtitle: Due May 23  @ 11:59PM
date: today
format:
  html:
    theme: cosmo
    embed-resources: true
    number-sections: true
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: false
engine: knitr
knitr:
  opts_chunk: 
    fig.align: 'center'
    # fig.width: 6
    # fig.height: 4
    message: FALSE
    cache: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```

```{r}
library(faraway) 
library(MASS) 
library(ggplot2)
library(tidyverse)
```

## Q1. ELMR Excercise 7.5 (p150) 

The debt data arise from a large postal survey on the psychology of debt. The frequency of credit card use is a three-level factor ranging from never, through occasionally to regularly.

```{r}
data(debt)
View(debt) 
```

(a) Declare the response as an ordered factor and make a plot showing the relationship to prodebt. Comment on the plot. Use a table or plot to display the relationship between the response and the income group.

**Solution ** 

1. Plot showcasing the relationship between credit card usage and pro-debt attitudes: 
The boxplot below illustrates how pro-debt attitudes (measured on a scale where higher values indicate a more favorable view of debt) vary according to credit card use frequency: never, occasionally, and regularly. There is a positive trend between the frequency of credit card use and pro-debt attitudes. Specifically, individuals who have never used credit cards tend to have lower pro-debt scores, with a median around 3. Those who occasionally use credit cards show a slight increase in the median pro-debt attitude, suggesting a more accepting view of debt. Finally, individuals who are regular credit card users have the highest median pro-debt score, indicating a stronger acceptance of debt. The spread of values is fairly consistent across groups, though outliers are more evident among those who use credit cards less frequently. Overall, the plot suggests that more frequent credit card users tend to have a more pro-debt mindset.

```{r}
debt$ccarduse <- factor(debt$ccarduse, 
                            levels = c(1, 2, 3), 
                            labels = c("never", "occasionally", "regularly"), 
                            ordered = TRUE)
```

```{r}
filtered_data <- debt %>%
  filter(!is.na(ccarduse), !is.na(prodebt))

ggplot(filtered_data, aes(x = ccarduse, y = prodebt, fill = ccarduse)) +
  geom_boxplot(alpha = 0.7, color = "black") +
  scale_fill_brewer(palette = "Pastel1") +  
  labs(
    title = "Pro-Debt Attitude by Credit Card Use Frequency",
    subtitle = "Survey analysis on credit behavior and debt attitude",
    x = "Credit Card Use Frequency",
    y = "Pro-Debt Attitude Score",
    fill = "Credit Card Use"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, margin = margin(b = 10)),
    legend.position = "none" 
  )
```


2. Plot showcasing Credit Card Use Frequency by Income Group: 
Shown below is a stacked proportional bar plot and the corresponding frequency table, showcasing the values corresponding to various levels of income group and credit card usage frequency. In lower income groups (1 and 2), the vast majority of individuals never used credit cards, with proportions exceeding 75 percent. As the income group increases, there is a gradual decline in the proportion of non-users and a rise in regular credit card usage. In the highest income group (indicated by 5), nearly half of individuals use credit cards regularly, while the proportion of individuals who have never used a credit card drops significantly. Occasional usage of credit cards (represented by the cyan color) remains stable across groups but also increases slightly with income. All in all, the stacked proportional bar plot suggests that higher income is positively associated with more frequent credit card use.

```{r}
filtered_data <- subset(debt_data, !is.na(ccarduse) & !is.na(incomegp))
table(filtered_data$ccarduse, filtered_data$incomegp)
ggplot(filtered_data, aes(x = incomegp, fill = ccarduse)) +
  geom_bar(position = "fill") +
  labs(title = "Credit Card Use Frequency by Income Group",
       x = "Income Group",
       y = "Proportion",
       fill = "Credit Card Use") +
  theme_minimal()
```

(b) Fit a proportional odds model for credit card use with all the other variables as predictors. What are the two most significant predictors (largest t-values) and what is their qualitative effect on the response? What is the least significant predictor?

**Solution ** 
The two most significant predictors (based on the largest t-values) are incomegp (t-value of 4.44) and bankacc (t-value of 3.55).

Interpretation for incomegp: Income group is a highly significant predictor of credit card use frequency. The odds of moving from "never" to "occasionally," or from "never/occasionally" to "regularly" using a credit card increase by a factor of exp(0.47) ≈ 1.6 for each additional increase in income group level.

Interpretation for bankacc: Having a bank account is another strong predictor of credit card use frequency. The odds of moving from "never" to "occasionally," or from "never/occasionally" to "regularly" using a credit card increase by a factor of exp(2.102) ≈ 8.18 for individuals who have a bank account compared to those who do not.

The least significant predictor is house (t-value of 0.499225). Whether or not an individual owns a house does not meaningfully differentiate their likelihood of using a credit card. If we were to interpret the coefficient for this predictor, it would suggest that the odds of moving from "never" to "occasionally," or from "occasionally" to "regularly" using a credit card increase by a factor of approximately 1.122 (exp(0.116) for individuals who own a house compared to those who do not. However, given the low t-value, this effect is not statistically significant.

```{r}
model <- polr(ccarduse ~ ., data = debt_data, Hess = TRUE, na.action = na.omit)
coef_summary <- coef(summary(model))

predictor_summary <- coef_summary[!grepl("/", rownames(coef_summary)), ]
t_values <- predictor_summary[, "t value"]
p_values <- pnorm(abs(t_values), lower.tail = FALSE) * 2

results <- data.frame(
  Predictor = rownames(predictor_summary),
  Coefficient = predictor_summary[, "Value"],
  Std_Error = predictor_summary[, "Std. Error"],
  t_value = t_values,
  p_value = p_values
) |> 
  arrange(desc(abs(t_value)))
results
```

(c) Fit a proportional odds model using only the least significant predictor from the previous model. What is the significance of this predictor in this small model? Are the conclusions regarding this predictor contradictory for the two models?

**Solution ** 

Below, we fit a proportional odds model using only the least significant predictor (house) from the previous model. In the full model, the house predictor is not statistically significant (p-value = 0.6176), suggesting no meaningful contribution to the frequency of credit card usage when other predictors are included. In the reduced model, however, house becomes highly significant (p-value = 0.0001), with a much larger coefficient of 0.558 and a t-value of 3.8951. This implies that when house is considered in isolation, it appears to have a strong relationship with credit card use frequency.

Interpretation of the coefficient: The odds of moving from "never" to "occasionally," or from "never/occasionally" to "regularly" using a credit card increase by a factor of exp(0.558) ≈ 1.747 for individuals who own a house compared to those who do not.

```{r}
full_model <- polr(ccarduse ~ ., data = debt_data, Hess = TRUE, na.action = na.omit)
reduced_model <- polr(ccarduse ~ house, data = debt_data, Hess = TRUE, na.action = na.omit)

extract_house_stats <- function(model) {
  sumry <- coef(summary(model))
  house_row <- sumry[rownames(sumry) == "house", ]
  t_val <- house_row["t value"]
  p_val <- pnorm(abs(t_val), lower.tail = FALSE) * 2
  data.frame(
    Coefficient = house_row["Value"],
    Std_Error = house_row["Std. Error"],
    t_value = t_val,
    p_value = p_val
  )
}

comparison_table <- rbind(
  data.frame(Model = "Full Model", extract_house_stats(full_model)),
  data.frame(Model = "Reduced Model", extract_house_stats(reduced_model))
)

knitr::kable(comparison_table, digits = 4, 
             caption = "Comparison of 'house' Predictor in Full vs. Reduced Models")
```

(d) Use stepwise AIC to select a smaller model than the full set of predictors. You will need to handle the missing values carefully. Report on the qualitative effect of the predictors in your chosen model. Can we conclude that the predictors that were dropped from the model have no relation to the response?

**Solution ** 

```{r}
step_model <- stepAIC(full_model, 
                     direction = "both",
                     trace = FALSE)  
summary(step_model) 
```

(e) Compute the median values of the predictors in your selected model. At these median values, contrast the predicted outcome probabilities for both smokers and nonsmokers.

**Solution ** 
We compute the median values of the predictors in the selected model from the previous question. 
The 

```{r}

```


(f) Fit a proportional hazards model to the same set of predictors and recompute the two sets of probabilities from the previous question. Does it make a difference to use this type of model?

**Solution ** 

```{r}

```


## Q2. Moments of exponential family distributions

**Solution** 
Solution is on another page. 


## Q3. Score and information matrix of GLM

**Solution ** 
Solution is on another page. 

## Q4. ELMR Exercise 8.1 (p171)


## Q5. ELMR Exercise 8.4 (p172)


## Q6. ELMR Exercise 8.5 (p172)













